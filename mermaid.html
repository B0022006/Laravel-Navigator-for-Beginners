<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }
        #contentArea > svg {
            min-width: 100vw;
            min-height: 100vh;
            width: auto;
            height: auto;
            background-color: white;

            transform-origin: 0 0;
            transition: transform 0.2s ease;
        }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
        window.mermaid = mermaid;
        mermaid.initialize({ startOnLoad: false, securityLevel: 'loose' });
    </script>
</head>
<body>
    <button id="updateButton" type="button">更新</button>
    <button id="resetButton" type="button">全強調表示解除</button>
    <div id="container">
        <div id="contentArea" class="mermaid"></div>
    </div>
</body>
<script>
    const vscode = acquireVsCodeApi();

    // pathタブの強調表示をする関数
    function highlightPath(path) {
        path.style.stroke = 'red'; // 強調表示の色
        path.style.strokeWidth = '5'; // 強調表示の太さ
        path.setAttribute('data-highlighted', 'true');
    }
    // pathタブの強調表示を解除する関数
    function unHighlightPath(path) {
        path.style.stroke = ''; // 元の色に戻す
        path.style.strokeWidth = ''; // 元の太さに戻す
        path.removeAttribute('data-highlighted');
    }

    // 更新ボタンのクリックイベント
    document.getElementById('updateButton').addEventListener('click', () => {
        vscode.postMessage({
            command: 'update',
        });
    });

    // リセットボタンのクリックイベント
        document.getElementById('resetButton').addEventListener('click', () => {
        const svg = document.querySelector('#contentArea svg');
        if (svg) {
            // 強調表示されているすべてのエッジを取得
            let highlightedPaths = svg.querySelectorAll('path[data-highlighted="true"]');
            highlightedPaths.forEach(path => {
                unHighlightPath(path);
            });
        }
    });

    window.addEventListener('load', () => {
        // Mermaidのコードの受信
        window.addEventListener('message', event => {
            document.getElementById("contentArea").removeAttribute('data-processed');

            const message = event.data;
            console.log(message.text);
            var contentArea = document.getElementById("contentArea");
            contentArea.innerHTML = message.text;

            mermaid.run({
                querySelector: '#contentArea',
            });

            // SVG生成後の処理
            const observer = new MutationObserver(mutations => {
                for (let mutation of mutations) {
                    for (let node of mutation.addedNodes) {
                        if (node.tagName && node.tagName.toLowerCase() === 'svg') {
                            let svg = node;

                            // ノードにタイトルを追加
                            let nodes = svg.querySelectorAll('g[class^="node"]');
                            nodes.forEach(node => {
                                let title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
                                title.textContent = 'Hello world!';
                                node.appendChild(title);
                            });

                            // エッジパスにオーバーレイを追加
                            let edgePaths = svg.querySelectorAll('path.flowchart-link');
                            edgePaths.forEach(path => {
                                // オーバーレイ用のパスを作成
                                let overlay = path.cloneNode();

                                // オーバーレイの属性を設定
                                overlay.style.strokeWidth = '25'; // クリック領域を広げるために太くする
                                overlay.style.stroke = 'transparent'; // デバッグのために青色に設定
                                overlay.setAttribute('fill', 'none');
                                overlay.style.pointerEvents = 'stroke'; // クリックイベントを有効にする

                                // クリックイベントリスナーを追加
                                overlay.addEventListener('click', function(e) {
                                    e.stopPropagation();

                                    // 元の線の色をトグル
                                    if (path.getAttribute('data-highlighted') === 'true') {
                                        // 強調表示を解除
                                        unHighlightPath(path);
                                    } else {
                                        // 強調表示
                                        highlightPath(path);
                                    }
                                });

                                // オーバーレイを元のパスの前に挿入
                                path.parentNode.insertBefore(overlay, path.nextSibling);
                            });

                            observer.disconnect();
                        }
                    }
                }
            });

            observer.observe(document.getElementById('contentArea'), { childList: true, subtree: true });
        });
    });

    // マウスホイールで拡大縮小
    let zoomLevel = 1;
    let zoomStep = 0.0005;
    document.addEventListener('wheel', function(e) {
        if (e.ctrlKey) {
            e.preventDefault();
            zoomLevel += e.deltaY * -zoomStep;
            zoomLevel = Math.min(Math.max(.1, zoomLevel), 3);
            document.getElementById("contentArea").style.transform = `scale(${zoomLevel})`;
        }
    });

    // ノードクリック時にVSCodeにファイル名と行番号を送信
    function clickHandler(file, line = null) {
        vscode.postMessage({
            command: 'nodeClicked',
            file: file,
            line: line,
        });
        console.log("送信しました");
    }

    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            mermaid.run({
                querySelector: '#contentArea',
            });
        }
    });
</script>
</html>
